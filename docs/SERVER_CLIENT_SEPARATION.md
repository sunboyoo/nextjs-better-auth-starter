# 服务端 / 客户端分离规范（供 AGENTS.md 引用）

> 本文件是 AGENTS 执行约束文档。涉及 API、页面、组件改动时，必须遵守以下规则。

## 1. 设计目标
将 `/api/*` 视作可复用服务层，支持多个前端入口（例如 `/admin`、未来业务前端）共享同一后端能力。

```
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   /admin     │  │   /app-1     │  │   /app-2     │
│   前端 UI    │  │   前端 UI    │  │   前端 UI    │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │
       └────────────┬────┴─────────────────┘
                    │
                    ▼
    ┌──────────────────────────────────────────────────────┐
    │                    /api/* (Server)                   │
    │  ┌─────────────┐               ┌──────────────────┐ │
    │  │ /api/admin  │               │ /api/other       │ │
    │  └─────────────┘               └──────────────────┘ │
    │                         │                            │
    │                     ┌───┴───┐                        │
    │                     │  DB   │                        │
    │                     └───────┘                        │
    └──────────────────────────────────────────────────────┘
```

## 2. 强制原则

### 2.1 API 层独立
1. `/api/**/route.ts` 禁止依赖 UI 组件与 React 客户端能力。
2. API 只返回数据（JSON/状态码），不承载展示逻辑。
3. API 设计需可被多个前端复用，不耦合单一路由页面。

### 2.2 数据访问边界
1. 允许在服务端路由、服务端工具层访问 `db`。
2. 禁止在 `src/components/**` 与非 API 页面组件直接导入 `@/db`。
3. 前端组件应通过 `fetch` / action / API client 访问数据。

### 2.3 高权限能力边界
1. 高权限操作（例如 admin 管理动作）必须在服务端执行。
2. 必须有显式授权守卫（例如 `requireAdmin()`）。
3. 客户端只负责触发，不得直接持有高权限数据库访问能力。

## 3. 目录分层建议（当前项目）

```
src/
├── app/
│   ├── api/                        # 服务端 API（可复用）
│   │   ├── admin/                  # 管理域 API
│   │   └── ...                     # 其他业务 API
│   ├── admin/                      # 管理后台前端
│   └── ...                         # 业务前端页面
├── components/                     # 前端组件层（禁止直接访问 db）
├── data/                           # 前端数据请求封装（query/mutation）
├── lib/                            # 服务端/通用工具
└── db/                             # schema + query 基础设施
```

## 4. 允许/禁止矩阵

| 位置 | 允许 | 禁止 |
|---|---|---|
| `src/app/api/**/route.ts` | `db`、`auth.api.*`、服务端工具 | UI 组件、React 客户端 hooks |
| `src/components/**` | 调用 API / server action | 直接导入 `@/db` |
| `src/app/**/page.tsx`（非 API） | 通过 API 或 server action 取数 | 直接导入 `@/db` |
| `src/data/**` | 前端查询封装、调用 API/client SDK | 直接写数据库 |

## 5. AGENTS 执行检查（提交前自检）

```bash
# 1) API 层不应依赖组件层
rg -n "@/components" src/app/api

# 2) 组件层不应直接访问数据库
rg -n "@/db" src/components

# 3) 非 API 页面不应直接访问数据库
rg -n "@/db" src/app --glob "*.tsx" | rg -v "src/app/api/"
```

期望结果：以上命令无输出（或仅为注释/示例文件，需人工确认）。

## 6. 与认证策略联动（简要）
1. 用户态 auth/session/account 功能遵循 Better Auth policy：优先 `auth.api.*` / `authClient.*`。
2. admin 能力需保持隔离：高权限动作走服务端路由 + 授权守卫。
3. 禁止把服务端密钥、管理能力泄露到浏览器可执行路径。
