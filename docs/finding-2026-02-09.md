# Auth Workflow Findings - 2026-02-09

## English

### Scope
- Audit target: authentication-related workflow for sign-in, sign-up, forgot-password, and profile completion.
- Validation performed: source review + `pnpm lint` + `pnpm build`.

### Findings (ordered by severity)
1. **High: Sign-in OTP paths can create new users and bypass profile-completion redirect**
- Config allows creation on OTP sign-in:
  - `src/lib/auth.ts:1223` (`emailOTP.disableSignUp` is false by default)
  - `src/lib/auth.ts:1292` (`phoneNumber.signUpOnVerification` is enabled)
- Sign-in form uses those create-capable endpoints:
  - `src/components/forms/sign-in-form.tsx:422` (`authClient.signIn.emailOtp`)
  - `src/components/forms/sign-in-form.tsx:528` (`authClient.phoneNumber.verify`)
- Sign-in success redirects to callback/dashboard, not forced profile completion:
  - `src/app/auth/sign-in/_components/sign-in.tsx:52`
- Only Sign Up flow consistently routes to profile completion:
  - `src/app/auth/sign-in/_components/sign-up.tsx:41`

2. **High: Profile completion can persist step 4 before completion finalization**
- Recovery step writes `nextStep: 4` before complete endpoint call:
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:934`
- Completion finalization happens after:
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:941`
- If complete API fails, persisted `currentStep` can still be 4 and produce unexpected step behavior on revisit:
  - `src/app/dashboard/profile-completion/page.tsx:93`

3. **Medium: Password-step visibility check can be inaccurate in edge cases**
- Current check treats presence of a credential account as equivalent to having a usable password:
  - `src/app/dashboard/profile-completion/page.tsx:76`
- This can misclassify some states and skip the password setup step unexpectedly.

4. **Medium: Recovery email flow is less strict because immediate email update is enabled**
- Global config enables:
  - `src/lib/auth.ts:1099` (`updateEmailWithoutVerification: true`)
- Recovery step uses `changeEmail` as part of verification flows:
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:661`
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:709`
- Behavior is valid by config but weaker than strict verify-first expectations.

5. **Low: Email sending is awaited in auth hooks**
- Examples:
  - `src/lib/auth.ts:1107`
  - `src/lib/auth.ts:1142`
  - `src/lib/auth.ts:1157`
  - `src/lib/auth.ts:1234`
- Better Auth docs recommend non-blocking delivery patterns to reduce timing-risk exposure.

### Validation Summary
- `pnpm lint`: passed.
- `pnpm build`: passed.

---

## 中文

### 范围
- 审查目标：登录、注册、忘记密码、资料补全等认证工作流。
- 验证方式：代码审查 + `pnpm lint` + `pnpm build`。

### 发现问题（按严重级别排序）
1. **高：登录页 OTP 路径可直接创建新用户，绕过资料补全跳转**
- 当前配置允许 OTP 登录时创建用户：
  - `src/lib/auth.ts:1223`（`emailOTP.disableSignUp` 默认是 false）
  - `src/lib/auth.ts:1292`（启用了 `phoneNumber.signUpOnVerification`）
- 登录表单调用了这些可能创建用户的接口：
  - `src/components/forms/sign-in-form.tsx:422`（`authClient.signIn.emailOtp`）
  - `src/components/forms/sign-in-form.tsx:528`（`authClient.phoneNumber.verify`）
- 登录成功后跳到 callback/dashboard，而不是强制资料补全：
  - `src/app/auth/sign-in/_components/sign-in.tsx:52`
- 只有注册流程稳定跳转到资料补全：
  - `src/app/auth/sign-in/_components/sign-up.tsx:41`

2. **高：资料补全在最终完成前就可能把步骤写成 4**
- 第 3 步会先保存 `nextStep: 4`，再调用完成接口：
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:934`
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:941`
- 如果 complete 接口失败，`currentStep` 仍可能是 4，回访时产生异常步骤表现：
  - `src/app/dashboard/profile-completion/page.tsx:93`

3. **中：密码步骤可见性判断在边界场景可能不准确**
- 目前通过“是否存在 credential account”来判定“是否已有密码”：
  - `src/app/dashboard/profile-completion/page.tsx:76`
- 在某些状态下可能误判，从而意外跳过密码设置步骤。

4. **中：恢复邮箱流程的严格性降低（启用了无需先验证再更新邮箱）**
- 全局配置：
  - `src/lib/auth.ts:1099`（`updateEmailWithoutVerification: true`）
- 资料补全第 3 步使用 `changeEmail`：
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:661`
  - `src/app/dashboard/profile-completion/_components/profile-completion-wizard.tsx:709`
- 该行为与配置一致，但安全策略上弱于“先验证后更新”的更严格方案。

5. **低：认证关键邮件发送逻辑使用了 await**
- 示例：
  - `src/lib/auth.ts:1107`
  - `src/lib/auth.ts:1142`
  - `src/lib/auth.ts:1157`
  - `src/lib/auth.ts:1234`
- Better Auth 文档建议采用非阻塞发送策略，以降低时序侧信道风险。

### 验证结果
- `pnpm lint`：通过。
- `pnpm build`：通过。
